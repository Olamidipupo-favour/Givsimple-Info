{% extends "base.html" %}

{% block title %}Write NFC Tag - GivSimple Info{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-7 col-md-9">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-nfc-symbol me-2"></i>Write your NFC Tag
      </div>
      <div class="card-body">
        <p>Use a compatible device (Android Chrome) and bring your NFC tag near your phone to write your profile URL. You can test with the preview below.</p>

        <div class="alert alert-success d-flex align-items-center" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          <div>
            Target URL:
            <code id="targetUrl">{{ profile_url }}</code>
          </div>
        </div>

        <div class="d-flex gap-2 mb-3">
          <button id="btnWrite" class="btn btn-primary"><i class="fas fa-pen-nib me-2"></i>Write Tag</button>
          <button id="btnTest" class="btn btn-outline-secondary"><i class="fas fa-link me-2"></i>Open URL</button>
        </div>

        <div id="status" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  async function writeNFC(url) {
    const statusEl = document.getElementById('status');
    statusEl.innerHTML = '';
    if (!('NDEFWriter' in window)) {
      statusEl.innerHTML = '<div class="alert alert-warning"><i class="fas fa-triangle-exclamation me-2"></i>Your browser does not support Web NFC. Try Android Chrome.</div>';
      return;
    }
    try {
      const writer = new NDEFWriter();
      await writer.write({ records: [{ recordType: 'url', data: url }] });
      statusEl.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Tag written successfully!</div>';
    } catch (err) {
      statusEl.innerHTML = '<div class="alert alert-danger"><i class="fas fa-xmark-circle me-2"></i>Failed to write tag: ' + (err && err.message ? err.message : err) + '</div>';
    }
  }

  document.getElementById('btnWrite').addEventListener('click', () => {
    const url = document.getElementById('targetUrl').textContent.trim();
    writeNFC(url);
  });
  document.getElementById('btnTest').addEventListener('click', () => {
    const url = document.getElementById('targetUrl').textContent.trim();
    window.open(url, '_blank');
  });
</script>
{% endblock %}